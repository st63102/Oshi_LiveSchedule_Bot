# 公演通知＆予定登録Bot

## ツールについて

### 目的

吉本興業の常設劇場スケジュールを自動でチェックし、キーワード登録した人物の公演情報があれば、Googleカレンダーへの予定登録とSlack・X(旧Twitter)への通知を行うGoogle Apps Scriptツールです。
これにより公式Webページ内を探し回る手間を省き、追加公演の見落としを防ぎます。

このリポジトリは、ポートフォリオ用に一部ソース・表現を改変したサンプルです。

### 特徴

![運用版ツールのイメージ](/image/公演通知＆予定登録Bot_ツールイメージ.png)

- 外部サービスとの連携
  - Googleカレンダーへの予定登録
  - Slackへの即時通知
  - X(旧Twitter)への自動ポスト
- メンテナンス性
  - 常設劇場の追加・削除をスプレッドシート上で管理
  - 設定項目をスクリプトプロパティに保存

### 技術・サービス

- Google Apps Script
- Googleカレンダー（API）
- Slack（Incoming Webhook）
- Twitter API v2

## ディレクトリ構成

```plaintext
Oshi_LiveSchedule_Bot/
├── src/                    # GASスクリプト（.gs, .html）
│   ├── main.gs             # メイン処理
│   ├── calendar.gs         # Googleカレンダー連携
│   ├── sheet.gs            # スプレッドシート連携
│   ├── slack.gs            # Slack通知処理
│   ├── theater.gs          # 劇場情報管理
│   ├── twitter.gs          # Twitter連携
│   ├── functions.gs        # 汎用関数
│   └── template.html       # 通知用テンプレート
├── image/                  # 画像ファイル（README・解説用）
│   └── 公演通知＆予定登録Bot_ツールイメージ.png
├── README.md               # プロジェクト説明
├── LICENSE                 # ライセンスファイル
├── appsscript.json         # GASマニフェストファイル
└── .gitignore              # Git管理対象外ファイル
```

## 使用ライブラリ

- Google Apps Script（GAS）の標準ライブラリのみを使用しています。
- 外部のnpmパッケージや追加ライブラリは利用していません。
- Twitter認証にはGoogle公式のOAuth2ライブラリを利用しています。
  - スクリプトID: `1B7FSrk5Zi6L1rSxxTDgDEUsPzlukDsi4KGuTMorsTQHhGBzBkMun4iDF`
  - バージョン: `43`
  - [公式GitHubリポジトリ](https://github.com/googleworkspace/apps-script-oauth2)

---

## 導入方法

### 1. （連携時）外部サービスの利用準備

外部サービスを利用しない場合、この手順は飛ばして構いません。

#### Googleカレンダー

- 予定を登録するカレンダーを用意し、`カレンダーの設定`画面に移動します。
- `カレンダーの統合`の`カレンダー ID`の値をコピーするなどして、控えます。
- 下記[スクリプトプロパティの登録](#スクリプトプロパティの登録)で、カレンダーIDを登録してください。

#### Slack

- Slackアカウント・ワークスペース・チャンネルを作成しておきます。
- [Slack Api](https://api.slack.com/apps)に移動します。
- `Your Apps` > `Create an App`ボタンをクリック
  - `From scratch`を選択
  - 通知を行うワークスペースと、アプリ名を登録します。
- アプリの管理画面に移動するので、`Features` > `Incoming Webhooks`をクリック
  - `Activate Incoming Webhooks`を**オン**に設定
- 管理画面の`App Home` > `Your App’s Presence in Slack` > `App Display Name` > `Edit` をクリック
  - 任意の名前`Display Name`と任意のユーザーネーム`Default username`を指定し、Botを作成する。
- `Features` > `Incoming Webhooks` > `Add New Webhook`をクリック
  - 投稿先チャンネルを選択して、権限リクエストを許可する
  - `Webhook URL`が発行されるので、下記[スクリプトプロパティの登録](#スクリプトプロパティの登録)で、投稿先チャンネルとURLを登録してください。

#### X（旧Twitter）

- [Twitter API v2(X API Free)の使い方・移行(2025年)【GAS】](https://qiita.com/neru-dev/items/857cc27fd69411496388)を参考に、手続きを行います。
- 以下の登録・生成を行ってください。
  - コールバックURLの登録
    - `https://script.google.com/macros/d/（GASスクリプトID）/usercallback`
  - Client ID、Client Secretの生成
- 下記[スクリプトプロパティの登録](#スクリプトプロパティの登録)でClient ID、Client Secretを登録してください。

---

### 2. スプレッドシートのコピー

- 以下のサンプルスプレッドシートを、自身のGoogleドライブにコピーします。
  - [公演通知＆予定登録Bot_サンプル](https://docs.google.com/spreadsheets/d/1Pt-EDRtsFVPNYENqBoZvXO_JyAy1JMVTp5sP2VgFvwg/edit?usp=sharing)
- プログラムが動作しなくなるため、**シート名や、劇場リスト以外のシート内データを変更しないでください**。

### 3. スクリプトファイルのペースト

- コピーしたスプレッドシートを開き、`拡張機能`タブ > `Apps Script`をクリックして、GASエディタを開きます。
- `src/` フォルダ内のスクリプトすべてをGASエディタに貼り付けます。

### 4. プロジェクトの設定

#### appsscript.jsonの適用

- GASエディタの左側にあるメニューから、`プロジェクトの設定`をクリックします。
- `全般設定`の`「appsscript.json」マニフェスト ファイルをエディタで表示する`にチェックをいれます。
- 左側メニューから`エディタ`をクリックします。
- ルートディレクトリ`appsscript.json`の内容を、GASエディタ内の`appsscript.json`に上書きし、保存します。
- `ライブラリ`欄に`OAuth2`が登録されていることを確認します。

#### スクリプトプロパティの登録

- GASエディタの左側にあるメニューから、`プロジェクトの設定`をクリックします。
- `スクリプト プロパティ` > `スクリプトプロパティの編集` > `スクリプトプロパティを追加`をクリックし、以下のプロパティ・値を登録します。
- `（自身の情報を入力）`と記載されている点は、使いたいアカウントの情報に合わせて入力してください。

| プロパティ名             | 例（値）                                            | 用途・説明                                                                                   |
| ------------------ | ----------------------------------------------- | --------------------------------------------------------------------------------------- |
| DAYS_UNTIL_ARCHIVE | 7                                               | アーカイブ猶予日数（過去公演をアーカイブするまでの日数）                                                            |
| GC_ID              | （自身の情報を入力）                                     | GoogleカレンダーID（予定登録先カレンダーのID）                                                            |
| KEY_WORDS          | ["中川家"]                                       | 検索キーワード（配列）：追加メニューから「検索キーワードの設定」を実行することでもセットできます。                                                                             |
| MAIN_LIVE_TITLE    | ["本公演", "週末ネタライブ", "WEEKEND寄席"]                 | 本公演系ライブ名リスト（カレンダー登録時のタイトル加工用）                                                           |
| POST_FLGS          | {"slack":true,"gCalendar":true,"twitter":false} | 外部サービス連携フラグ（slack/gCalendar/twitterのON/OFF）                                             |
| SLACK_CHANNEL      | #oshi-live                                      | 通知先のSlackチャンネル名                                                                         |
| SLACK_WEBHOOK_URL  | （自身の情報を入力）                                     | Slack通知用Webhook URL                                                                     |
| SLEEP_TIME         | 1000                                            | API実行前の待機時間（ミリ秒）                                                                        |
| SLEEP_TIME_POSTS   | 100                                              | 1劇場で複数新着時の2件目以降の待機時間（ミリ秒）                                                               |
| SS_ID              | （自身の情報を入力）                                    | このプロジェクトがバインドされているスプレッドシートのID                                                           |
| THEATER_LIST       | （手入力不要）                                         | 劇場リスト。スプレッドシートの「劇場リスト」シートを編集し、追加メニューから「現在の常設劇場リストを検索対象に設定」を実行することで自動的にセットされます。 |
| TWITTER_CLIENT_ID  | （自身の情報を入力）                                     | Twitter APIのClient ID（認証用）                                                              |
| TWITTER_CLIENT_SEC | （自身の情報を入力）                                     | Twitter APIのClient Secret（認証用）                                                          |
| TWITTER_ID         | （自身の情報を入力）                                     | TwitterユーザーID（認証情報管理用）                                                                  |

### 5. 劇場情報・検索ワード・外部サービス連携の設定

- スプレッドシートを開きます。
- `劇場リスト`シートの内容が、実際の状況と一致するようにします。
  - （新規劇場が開館した場合は、劇場のスケジュールページからデベロッパーツール等を利用して内容を保管してください）
- `追加メニュー▶` > `劇場リストシートの内容を検索対象に設定` を実行します。
  - 登録完了するとメッセージが表示されます。
- `追加メニュー▶` > `検索キーワードの設定` を実行します。
  - 検索したい出演者名を入力してください。複数組存在する場合、一組ずつ入力 > OK を繰り返してください。
- `追加メニュー▶` > `外部サービスの連携設定` を実行します。
  - Slack、Googleカレンダー、Twitterの連携可否をそれぞれ設定してください。

### 6. Twitterの認証情報登録

- Twitter連携を利用する場合は、初回のみ以下の作業が必要です。
  - 投稿を行いたいTwitterアカウントでログインしておきます。
  - `追加メニュー▶` > `Twitter認証` > `認証の実行` を実行します。
  - 認証メッセージが表示されるので、メッセージ下部の`アクセス承認`をクリックします。
  - Twitterに遷移するので、`アプリにアクセスを許可`を選択すると、プロパティにアカウント認証情報が保存されます。

## 運用方法

- GASエディタから`トリガー`を開き、以下のトリガーを設定することで、自動で新着情報を通知させることができます。
  - 実行する関数：`oshiLive`
  - イベントのソースを選択：`時間主導型`
  - 時間ベースのトリガーのタイプを選択：`時間ベースのタイマー`
  - 時刻を選択：`２時間おき`（おすすめ）
    > ⚠️ **ご注意ください**  
    > 頻繁なアクセスはサーバー負荷となるため、おやめください。また頻度が短いと、GASの1日実行時間制限に到達するためご注意ください。
- また、実行時間節約のため、定期的に公演情報をアーカイブする、以下トリガーの設定もおすすめです。
  - 実行する関数：`archiveSchedule`
  - イベントのソースを選択：`時間主導型`
  - 時間ベースのトリガーのタイプを選択：`月ベースのタイマー`
  - 日・時刻を選択：`任意のタイミングを指定`

---

## 謝辞

本プロジェクトにおけるTwitterのOAuth2認証処理は、officeの杜さんの
[Google Apps ScriptからTwitter APIをOAuth2.0認証で使う【GAS】](https://officeforest.org/wp/2023/01/14/google-apps-script%e3%81%8b%e3%82%89twitter-api%e3%82%92oauth2-0%e8%aa%8d%e8%a8%bc%e3%81%a7%e4%bd%bf%e3%81%86/)
の記事を参考にさせていただきました。誠にお礼申し上げます。

## ライセンス

このプロジェクトは MIT ライセンスのもとで公開されています。
